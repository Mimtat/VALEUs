<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Interactive Gephi Diagram</title>
  <style>
    :root{
      --panel-w: 280px;
      --pad: 12px;
      --gap: 10px;
      --radius: 10px;
      --shadow: 0 2px 10px rgba(0,0,0,0.14);
      --border: 1px solid rgba(0,0,0,0.10);
      --font: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }

    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: #ffffff;
    }

    #container {
      width: 100vw;
      height: 100vh;
      background: #ffffff;
    }

    #sidebar {
      position: fixed;
      top: 12px;
      left: 12px;
      z-index: 9999;
      width: var(--panel-w);
      display: grid;
      gap: var(--gap);
      font-family: var(--font);
    }

    .panel {
      background: rgba(255,255,255,0.96);
      border: var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: var(--pad);
    }

    .panel-title {
      font-weight: 700;
      font-size: 13px;
      margin-bottom: 8px;
    }

    .controls-row{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    button {
      height: 36px;
      border-radius: 9px;
      border: 1px solid rgba(0,0,0,0.16);
      background: #fff;
      cursor: pointer;
      font-size: 13px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    button:hover { background: rgba(0,0,0,0.03); }

    .filters-grid{
      display: grid;
      gap: 6px;
    }

    label {
      display: grid;
      grid-template-columns: 18px 1fr;
      align-items: center;
      gap: 10px;
      font-size: 13px;
      padding: 6px 8px;
      border-radius: 8px;
    }

    label:hover { background: rgba(0,0,0,0.03); }

    input[type="checkbox"]{
      width: 16px;
      height: 16px;
      margin: 0;
    }

    .year-row{
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
      font-size: 13px;
    }

    #yearValue{
      font-variant-numeric: tabular-nums;
      font-weight: 700;
      min-width: 44px;
      text-align: right;
    }

    input[type="range"]{
      width: 100%;
    }

    .small-note{
      margin-top: 8px;
      font-size: 12px;
      opacity: 0.7;
    }
  </style>
</head>

<body>
<div id="sidebar">

  <div class="panel">
    <div class="panel-title">Layout</div>
    <div class="controls-row">
      <button id="toggle">⏸ Pause</button>
      <button id="noverlap">✨ Space</button>
    </div>
  </div>

  <div class="panel">
    <div class="panel-title">Filter</div>
    <div class="filters-grid" id="filters">
      <label><input type="checkbox" value="Country" checked> Country</label>
      <label><input type="checkbox" value="Project" checked disabled> Project</label>
      <label><input type="checkbox" value="Addressee" checked> Addressee</label>
      <label><input type="checkbox" value="Organization" checked> Organization</label>
      <label><input type="checkbox" value="Action Domain" checked> Action Domain</label>
      <label><input type="checkbox" value="Kind of Action" checked> Kind of Action</label>
    </div>
  </div>

  <div class="panel">
    <div class="panel-title">Time</div>
    <div class="year-row">
      <span>Year</span>
      <span id="yearValue">2010</span>
    </div>
    <input type="range" id="yearSlider" min="2010" max="2025" value="2010">
    <div class="small-note">
      Non-project nodes appear only if linked to projects active in that year.
    </div>
  </div>

</div>

<div id="container"></div>

<script type="module">
import Sigma from "https://cdn.jsdelivr.net/npm/sigma@3.0.2/+esm";
import Graph from "https://cdn.jsdelivr.net/npm/graphology@0.25.4/+esm";
import forceAtlas2 from "https://cdn.jsdelivr.net/npm/graphology-layout-forceatlas2/+esm";
import noverlap from "https://cdn.jsdelivr.net/npm/graphology-layout-noverlap/+esm";

document.addEventListener("DOMContentLoaded", () => {
  fetch("PrjAdd-2509.json")
    .then(r => r.json())
    .then(data => {

      const g = new Graph();
      let currentYear = 2010;
      let running = true;

      const colorMap = {
        Country: "rgb(102,255,255)",
        Project: "rgb(255,102,102)",
        Organization: "rgb(102,102,255)",
        Addressee: "rgb(255,255,102)",
        "Action Domain": "rgb(255,102,255)",
        "Kind of Action": "rgb(102,255,102)"
      };

      const actionTypes = new Set([
        "Research","Monitoring","Capacity Building","Advocacy",
        "Protest","Education/Literacy","engaged art"
      ]);

      data.nodes.forEach(n => {
        let m = n.attributes.metaType || "";
        if (actionTypes.has(m)) m = "Kind of Action";

        const raw = Number(n.attributes.size) || 1;
        const size = Math.max(2, Math.min(18, Math.sqrt(raw) * 2));

        g.addNode(n.key, {
          label: n.attributes.label,
          x: Number(n.attributes.x),
          y: Number(n.attributes.y),
          size,
          color: colorMap[m],
          metaType: m,
          startYear: n.attributes.startYear ?? null,
          endYear: n.attributes.endYear ?? null
        });
      });

      data.edges.forEach((e, i) => {
        g.addEdgeWithKey(
          e.key || "e"+i,
          e.source,
          e.target,
          { color: "#bdbdbd", size: 1 }
        );
      });

      const renderer = new Sigma(g, document.getElementById("container"));

      const fa2 = {
        linLogMode: true,
        adjustSizes: true,
        gravity: 0.03,
        scalingRatio: 60,
        slowDown: 1
      };

      function loop() {
        if (running) {
          forceAtlas2.assign(g, { iterations: 2, settings: fa2 });
          renderer.refresh();
        }
        requestAnimationFrame(loop);
      }
      loop();

      setInterval(() => {
        if (running) {
          noverlap.assign(g, { margin: 10, ratio: 1.1 });
          renderer.refresh();
        }
      }, 900);

      document.getElementById("toggle").onclick = () => {
        running = !running;
        document.getElementById("toggle").textContent =
          running ? "⏸ Pause" : "▶ Resume";
      };

      document.getElementById("noverlap").onclick = () => {
        running = false;
        document.getElementById("toggle").textContent = "▶ Resume";
        noverlap.assign(g, { margin: 18, ratio: 1.35, speed: 4 });
        renderer.refresh();
      };

      document.getElementById("yearSlider").oninput = e => {
        currentYear = +e.target.value;
        document.getElementById("yearValue").textContent = currentYear;
        renderer.refresh();
      };
    });
});
</script>
</body>
</html>
