<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Interactive Gephi Network</title>
  <style>
    body { margin: 0; font-family: Arial, sans-serif; }
    #controls {
      position: absolute; top: 10px; left: 10px; z-index: 10;
      background: rgba(255, 255, 255, 0.9); padding: 8px; border-radius: 6px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    #graph-container {
      width: 100vw; height: 100vh;
    }
    #tooltip {
      position: absolute; padding: 6px 10px; background: #fff;
      border: 1px solid #ccc; border-radius: 4px;
      display: none; pointer-events: none; font-size: 14px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
  </style>
</head>
<body>
  <div id="controls">
    <button id="toggleLayout">⏸ Pause layout</button><br><br>
    <label><input type="checkbox" value="Organization" checked> Organization</label><br>
    <label><input type="checkbox" value="Addressee" checked> Addressee</label><br>
    <label><input type="checkbox" value="Action Domain" checked> Action Domain</label><br>
    <!-- Project is always visible -->
  </div>
  <div id="graph-container"></div>
  <div id="tooltip"></div>

  <script src="https://unpkg.com/graphology/dist/graphology.umd.min.js"></script>
  <script src="https://unpkg.com/graphology-layout-forceatlas2/worker.js"></script>
  <script src="https://unpkg.com/sigma/build/sigma.min.js"></script>
  <script>
    const container = document.getElementById("graph-container");
    const tooltip = document.getElementById("tooltip");

    // --- Flags map ---
    const flagMap = {
      Germany: "https://flagcdn.com/w40/de.png",
      Poland: "https://flagcdn.com/w40/pl.png",
      Sweden: "https://flagcdn.com/w40/se.png",
      Estonia: "https://flagcdn.com/w40/ee.png",
      Switzerland: "https://flagcdn.com/w40/ch.png",
      Ukraine: "https://flagcdn.com/w40/ua.png",
      Romania: "https://flagcdn.com/w40/ro.png",
      Hungary: "https://flagcdn.com/w40/hu.png",
      Slovakia: "https://flagcdn.com/w40/sk.png",
      Bulgaria: "https://flagcdn.com/w40/bg.png",
      Slovenia: "https://flagcdn.com/w40/si.png",
      Moldova: "https://flagcdn.com/w40/md.png",
      Kazakhstan: "https://flagcdn.com/w40/kz.png",
      Serbia: "https://flagcdn.com/w40/rs.png",
      "Czech Republic": "https://flagcdn.com/w40/cz.png",
      Japon: "https://flagcdn.com/w40/jp.png"
    };

    // --- Color palette (combinations of 102,255) ---
    const palette = [
      "rgb(102,255,102)",
      "rgb(102,102,255)",
      "rgb(255,102,102)",
      "rgb(255,255,102)",
      "rgb(255,102,255)",
      "rgb(102,255,255)"
    ];
    const metaTypes = ["Project","Organization","Addressee","Action Domain"];
    const colorMap = {};
    metaTypes.forEach((t,i)=>{ colorMap[t] = palette[i % palette.length]; });

    // --- Active filters ---
    let activeTypes = new Set(metaTypes); // Project always on

    // --- Load JSON graph ---
    fetch("PrjAdd-2509.json")
      .then(r => r.json())
      .then(data => {
        const g = new graphology.Graph();

        // Add nodes
        data.nodes.forEach(n => {
          const m = n.attributes.metaType || "default";
          let col = (m !== "Country") ? (colorMap[m] || "#999") : "#ccc";
          g.addNode(n.key, {
            label: n.attributes.label,
            x: Number(n.attributes.x),
            y: Number(n.attributes.y),
            size: Number(n.attributes.size),
            color: col,
            metaType: m
          });
        });

        // Add edges
        data.edges.forEach(e => {
          g.addEdge(e.source, e.target, e.attributes || {});
        });

        // Sigma renderer
        const renderer = new sigma.Sigma(g, container);

        // ForceAtlas2
        const fa2 = new forceAtlas2.ForceAtlas2Supervisor(g, { settings: { slowDown: 10 } });
        fa2.start();

        let running = true;
        document.getElementById("toggleLayout").onclick = () => {
          if (running) {
            fa2.stop();
            running = false;
            document.getElementById("toggleLayout").innerText = "▶ Resume layout";
          } else {
            fa2.start();
            running = true;
            document.getElementById("toggleLayout").innerText = "⏸ Pause layout";
          }
        };

        // Node reducer (filtering)
        renderer.setSetting("nodeReducer", (node, data) => {
          const res = { ...data };
          if (res.metaType !== "Project" && !activeTypes.has(res.metaType)) {
            res.hidden = true;
          }
          return res;
        });

        renderer.setSetting("edgeReducer", (edge, data) => {
          const res = { ...data };
          const srcType = g.getNodeAttribute(g.source(edge), "metaType");
          const tgtType = g.getNodeAttribute(g.target(edge), "metaType");
          if ((srcType !== "Project" && !activeTypes.has(srcType)) ||
              (tgtType !== "Project" && !activeTypes.has(tgtType))) {
            res.hidden = true;
          }
          return res;
        });

        // Tooltip with flags
        renderer.on("enterNode", ({ node }) => {
          const attrs = g.getNodeAttributes(node);
          let html = attrs.label;
          if (attrs.metaType === "Country" && flagMap[attrs.label]) {
            html = `<img src="${flagMap[attrs.label]}" style="height:14px; margin-right:6px; vertical-align:middle;">${attrs.label}`;
          }
          tooltip.innerHTML = html;
          tooltip.style.display = "block";
        });
        renderer.on("leaveNode", () => { tooltip.style.display = "none"; });
        renderer.on("mousemove", e => {
          tooltip.style.left = e.event.x + 10 + "px";
          tooltip.style.top = e.event.y + 10 + "px";
        });

        // Filter checkboxes
        document.querySelectorAll('#controls input[type=checkbox]').forEach(cb => {
          cb.addEventListener("change", e => {
            const val = e.target.value;
            if (e.target.checked) activeTypes.add(val);
            else activeTypes.delete(val);
            renderer.refresh();
          });
        });
      });
  </script>
</body>
</html>
