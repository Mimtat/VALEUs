<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Interactive Gephi Network</title>
  <style>
    body { margin: 0; font-family: Arial, sans-serif; }
    #controls {
      position: absolute; top: 10px; left: 10px; z-index: 10;
      background: rgba(255, 255, 255, 0.9); padding: 8px; border-radius: 6px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    #graph-container { width: 100vw; height: 100vh; }
  </style>
</head>
<body>
  <div id="controls">
    <button id="toggleLayout">⏸ Pause layout</button><br><br>
    <label><input type="checkbox" value="Organization" checked> Organization</label><br>
    <label><input type="checkbox" value="Addressee" checked> Addressee</label><br>
    <label><input type="checkbox" value="Action Domain" checked> Action Domain</label><br>
    <!-- Project is always visible -->
  </div>
  <div id="graph-container"></div>

  <!-- ✅ Correct UMD bundles -->
  <script src="https://unpkg.com/graphology/dist/graphology.umd.min.js"></script>
  <script src="https://unpkg.com/graphology-layout-forceatlas2/umd/graphology-layout-forceatlas2.min.js"></script>
  <script src="https://unpkg.com/graphology-layout-forceatlas2/umd/worker.min.js"></script>
  <script src="https://unpkg.com/sigma@2.4.0/build/sigma.min.js"></script>

  <script>
    const container = document.getElementById("graph-container");

    // --- Bright [102,255] palette ---
    const palette = [
      "rgb(102,255,102)",  // green
      "rgb(102,102,255)",  // blue
      "rgb(255,102,102)",  // red
      "rgb(255,255,102)",  // yellow
      "rgb(255,102,255)",  // magenta
      "rgb(102,255,255)"   // cyan
    ];
    const metaTypes = ["Project","Organization","Addressee","Action Domain"];
    const colorMap = {};
    metaTypes.forEach((t,i)=>{ colorMap[t] = palette[i % palette.length]; });

    // --- Active filters ---
    let activeTypes = new Set(metaTypes);

    // --- Load JSON graph ---
    fetch("PrjAdd-2509.json")
      .then(r => r.json())
      .then(data => {
        const g = new graphology.Graph();

        // Add nodes
        data.nodes.forEach(n => {
          const m = n.attributes.metaType || "default";
          const col = colorMap[m] || "#999999";
          g.addNode(n.key, {
            label: n.attributes.label,
            x: Number(n.attributes.x),
            y: Number(n.attributes.y),
            size: Number(n.attributes.size),
            color: col,
            metaType: m
          });
        });

        // Add edges
        data.edges.forEach(e => {
          g.addEdge(e.source, e.target, e.attributes || {});
        });

        // Sigma renderer
        const renderer = new Sigma(g, container);

        // ForceAtlas2
        const fa2 = new forceAtlas2.ForceAtlas2Supervisor(g, { settings: { slowDown: 10 } });
        fa2.start();

        let running = true;
        document.getElementById("toggleLayout").onclick = () => {
          if (running) {
            fa2.stop();
            running = false;
            document.getElementById("toggleLayout").innerText = "▶ Resume layout";
          } else {
            fa2.start();
            running = true;
            document.getElementById("toggleLayout").innerText = "⏸ Pause layout";
          }
        };

        // Node reducer (filtering)
        renderer.setSetting("nodeReducer", (node, data) => {
          const res = { ...data };
          if (res.metaType !== "Project" && !activeTypes.has(res.metaType)) {
            res.hidden = true;
          }
          return res;
        });

        // Edge reducer (filtering)
        renderer.setSetting("edgeReducer", (edge, data) => {
          const res = { ...data };
          const srcType = g.getNodeAttribute(g.source(edge), "metaType");
          const tgtType = g.getNodeAttribute(g.target(edge), "metaType");
          if ((srcType !== "Project" && !activeTypes.has(srcType)) ||
              (tgtType !== "Project" && !activeTypes.has(tgtType))) {
            res.hidden = true;
          }
          return res;
        });

        // Filter checkboxes
        document.querySelectorAll('#controls input[type=checkbox]').forEach(cb => {
          cb.addEventListener("change", e => {
            const val = e.target.value;
            if (e.target.checked) activeTypes.add(val);
            else activeTypes.delete(val);
            renderer.refresh();
          });
        });
      });
  </script>
</body>
</html>
