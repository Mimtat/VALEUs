<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Interactive Gephi Diagram</title>
  <style>
    :root{
      --panel-w: 280px;
      --pad: 12px;
      --gap: 10px;
      --radius: 10px;
      --shadow: 0 2px 10px rgba(0,0,0,0.14);
      --border: 1px solid rgba(0,0,0,0.10);
      --font: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }

    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: #ffffff;
    }

    #container {
      width: 100vw;
      height: 100vh;
      background: #ffffff;
    }

    #sidebar {
      position: fixed;
      top: 12px;
      left: 12px;
      z-index: 9999;
      width: var(--panel-w);
      display: grid;
      gap: var(--gap);
      font-family: var(--font);
    }

    .panel {
      background: rgba(255,255,255,0.96);
      border: var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: var(--pad);
    }

    .panel-title {
      font-weight: 700;
      font-size: 13px;
      margin-bottom: 8px;
    }

    .controls-row{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    button {
      height: 36px;
      border-radius: 9px;
      border: 1px solid rgba(0,0,0,0.16);
      background: #fff;
      cursor: pointer;
      font-size: 13px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    button:hover { background: rgba(0,0,0,0.03); }

    .filters-grid{
      display: grid;
      gap: 6px;
    }

    label {
      display: grid;
      grid-template-columns: 18px 1fr;
      align-items: center;
      gap: 10px;
      font-size: 13px;
      padding: 6px 8px;
      border-radius: 8px;
      margin: 0;
    }
    label:hover { background: rgba(0,0,0,0.03); }

    input[type="checkbox"]{
      width: 16px;
      height: 16px;
      margin: 0;
    }

    .year-row{
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
      font-size: 13px;
    }

    #yearValue{
      font-variant-numeric: tabular-nums;
      font-weight: 700;
      min-width: 44px;
      text-align: right;
    }

    input[type="range"]{ width: 100%; }

    .small-note{
      margin-top: 8px;
      font-size: 12px;
      opacity: 0.7;
      line-height: 1.25;
    }
  </style>
</head>

<body>
<div id="sidebar">

  <div class="panel">
    <div class="panel-title">Layout</div>
    <div class="controls-row">
      <button id="toggle">⏸ Pause</button>
      <button id="noverlap">✨ Space</button>
    </div>
  </div>

  <div class="panel">
    <div class="panel-title">Filter</div>
    <div class="filters-grid" id="filters">
      <label><input type="checkbox" value="Country" checked> Country</label>
      <label><input type="checkbox" value="Project" checked disabled> Project</label>
      <label><input type="checkbox" value="Addressee" checked> Addressee</label>
      <label><input type="checkbox" value="Organization" checked> Organization</label>
      <label><input type="checkbox" value="Action Domain" checked> Action Domain</label>
      <label><input type="checkbox" value="Kind of Action" checked> Kind of Action</label>
    </div>
  </div>

  <div class="panel">
    <div class="panel-title">Time</div>
    <div class="year-row">
      <span>Year</span>
      <span id="yearValue">2010</span>
    </div>
    <input type="range" id="yearSlider" min="2010" max="2025" value="2010" step="1">
    <div class="small-note">
      Non-project nodes appear only if linked to projects active in that year.
    </div>
  </div>

</div>

<div id="container"></div>

<script type="module">
import Sigma from "https://cdn.jsdelivr.net/npm/sigma@3.0.2/+esm";
import Graph from "https://cdn.jsdelivr.net/npm/graphology@0.25.4/+esm";
import forceAtlas2 from "https://cdn.jsdelivr.net/npm/graphology-layout-forceatlas2/+esm";
import noverlap from "https://cdn.jsdelivr.net/npm/graphology-layout-noverlap/+esm";

document.addEventListener("DOMContentLoaded", () => {
  fetch("PrjAdd-2509.json")
    .then(r => r.json())
    .then(data => {

      // ✅ MULTI GRAPH: allows multiple edges between same nodes
      const g = new Graph({ multi: true });

      let currentYear = 2010;
      let running = true;

      const colorMap = {
        Country: "rgb(102,255,255)",
        Project: "rgb(255,102,102)",
        Organization: "rgb(102,102,255)",
        Addressee: "rgb(255,255,102)",
        "Action Domain": "rgb(255,102,255)",
        "Kind of Action": "rgb(102,255,102)"
      };

      const actionTypes = new Set([
        "Research","Monitoring","Capacity Building","Advocacy",
        "Protest","Education/Literacy","engaged art"
      ]);

      // Nodes
      data.nodes.forEach(n => {
        let m = n.attributes?.metaType || "";
        if (actionTypes.has(m)) m = "Kind of Action";

        const raw = Number(n.attributes?.size);
        const safe = Number.isFinite(raw) ? raw : 1;
        const size = Math.max(2, Math.min(18, Math.sqrt(safe) * 2));

        const sY = Number(n.attributes?.startYear);
        const eY = Number(n.attributes?.endYear);

        g.addNode(n.key, {
          label: n.attributes?.label || n.key,
          x: Number(n.attributes?.x) || 0,
          y: Number(n.attributes?.y) || 0,
          size,
          color: colorMap[m] || "#000",
          metaType: m,
          startYear: Number.isFinite(sY) ? sY : null,
          endYear: Number.isFinite(eY) ? eY : null
        });
      });

      // Edges (grey; unique keys)
      data.edges.forEach((e, i) => {
        const k = e.key || `e_${i}_${e.source}_${e.target}`;
        const attrs = {
          color: "#bdbdbd",
          size: Number(e.attributes?.weight) || 1
        };

        // In a multi graph we can always add edges between same endpoints,
        // but keys still must be unique:
        const key = g.hasEdge(k) ? `${k}_${i}` : k;

        if (e.undirected) {
          g.addUndirectedEdgeWithKey(key, e.source, e.target, attrs);
        } else {
          g.addEdgeWithKey(key, e.source, e.target, attrs);
        }
      });

      const renderer = new Sigma(g, document.getElementById("container"));
      renderer.setSetting("defaultEdgeColor", "#bdbdbd");
      renderer.setSetting("edgeColor", "color");

      const fa2 = {
        linLogMode: true,
        adjustSizes: true,
        gravity: 0.03,
        scalingRatio: 60,
        slowDown: 1
      };

      // Layout loop
      function loop() {
        if (running) {
          forceAtlas2.assign(g, { iterations: 2, settings: fa2 });
          renderer.refresh();
        }
        requestAnimationFrame(loop);
      }
      loop();

      // Periodic anti-overlap
      setInterval(() => {
        if (running) {
          noverlap.assign(g, { margin: 10, ratio: 1.1 });
          renderer.refresh();
        }
      }, 900);

      // Controls
      const toggleBtn = document.getElementById("toggle");
      toggleBtn.onclick = () => {
        running = !running;
        toggleBtn.textContent = running ? "⏸ Pause" : "▶ Resume";
      };

      document.getElementById("noverlap").onclick = () => {
        running = false;
        toggleBtn.textContent = "▶ Resume";
        noverlap.assign(g, { margin: 18, ratio: 1.35, speed: 4 });
        renderer.refresh();
      };

      // Year slider (kept simple here; your full emergence reducers can be re-added)
      const yearSlider = document.getElementById("yearSlider");
      const yearValue = document.getElementById("yearValue");
      yearSlider.oninput = e => {
        currentYear = +e.target.value;
        yearValue.textContent = currentYear;
        renderer.refresh();
      };
    });
});
</script>
</body>
</html>
